{
  # Local development configuration
  local_certs
}

localhost:8443 {
  encode zstd gzip

  header {
    # CORS for Netlify origin only
    Access-Control-Allow-Origin "https://fredav.netlify.app"
    Access-Control-Allow-Methods "GET,OPTIONS"
    Access-Control-Allow-Headers "Authorization, Range, Content-Type"
    Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range"
    # Basic security
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer"
    Permissions-Policy "autoplay=(), fullscreen=(), microphone=()"
  }

  # Handle preflight
  @cors {
    method OPTIONS
    path /api/*
  }
  
  respond @cors 204

  # Reverse proxy to local Node server
  reverse_proxy localhost:8080
}

# Production configuration
fredav-videoparty.duckdns.org {
  encode zstd gzip

  header {
    # CORS for Netlify origin only
    Access-Control-Allow-Origin "https://fredav.netlify.app"
    Access-Control-Allow-Methods "GET,OPTIONS"
    Access-Control-Allow-Headers "Authorization, Range, Content-Type"
    Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range"
    # Basic security
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer"
    Permissions-Policy "autoplay=(), fullscreen=(), microphone=()"
    # HSTS for production
    Strict-Transport-Security "max-age=31536000; includeSubDomains"
  }

  # Handle preflight
  @cors_prod {
    method OPTIONS
    path /api/*
  }
  
  respond @cors_prod 204

  # Reverse proxy to local Node server
  reverse_proxy localhost:8080
}
